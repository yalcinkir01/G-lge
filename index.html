<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gölge Ustası - Seviyeli</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; }
        .stat { font-size: 20px; margin-bottom: 5px; }
        #level-up { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    font-size: 40px; color: yellow; display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat" id="lvl">SEVİYE: 1</div>
        <div class="stat" id="tur">TUR: 0 / 2</div>
        <div class="stat" id="score">PUAN: 0</div>
    </div>
    <div id="level-up">SEVİYE ATLADIN!</div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Oyun Değişkenleri
        let level = 1;
        let score = 0;
        let gameActive = true;
        let angle = 0;
        let rotationSpeed = 0.02;
        let currentLaps = 0;
        let lastAngle = 0;
        let totalRotation = 0;

        // Oyuncu
        let player = { x: 100, y: 100, radius: 8, speed: 5 };
        let keys = {};

        // Engeller (Geometrik Şekiller)
        const obstacles = [
            { x: -150, y: -150, type: 'square', size: 40 },
            { x: 180, y: -50, type: 'triangle', size: 45 },
            { x: 50, y: 150, type: 'pentagon', size: 35 }
        ];

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function drawObstacle(obj) {
            ctx.fillStyle = "#555";
            ctx.beginPath();
            const centerX = canvas.width/2 + obj.x;
            const centerY = canvas.height/2 + obj.y;

            if(obj.type === 'square') {
                ctx.rect(centerX - obj.size/2, centerY - obj.size/2, obj.size, obj.size);
            } else if(obj.type === 'triangle') {
                for(let i=0; i<3; i++) {
                    let a = (i * 2 * Math.PI / 3) - Math.PI/2;
                    ctx.lineTo(centerX + obj.size * Math.cos(a), centerY + obj.size * Math.sin(a));
                }
            } else if(obj.type === 'pentagon') {
                for(let i=0; i<5; i++) {
                    let a = (i * 2 * Math.PI / 5) - Math.PI/2;
                    ctx.lineTo(centerX + obj.size * Math.cos(a), centerY + obj.size * Math.sin(a));
                }
            }
            ctx.closePath();
            ctx.fill();
        }

        function checkInShadow(px, py, lightAngle) {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            for (let obs of obstacles) {
                const ox = cx + obs.x;
                const oy = cy + obs.y;
                
                // Oyuncu engelin arkasında mı? (Basit mesafe ve açı kontrolü)
                const distPlayer = Math.hypot(px - cx, py - cy);
                const distObs = Math.hypot(ox - cx, oy - cy);
                
                if (distPlayer > distObs) {
                    const angleObs = Math.atan2(oy - cy, ox - cx);
                    const anglePlayer = Math.atan2(py - cy, px - cx);
                    
                    if (Math.abs(angleObs - anglePlayer) < 0.2) {
                        return true; // Gölgedesin!
                    }
                }
            }
            return false;
        }

        function update() {
            if (!gameActive) return;

            // Hareket Kontrolü
            if (keys['ArrowUp'] || keys['KeyW']) player.y -= player.speed;
            if (keys['ArrowDown'] || keys['KeyS']) player.y += player.speed;
            if (keys['ArrowLeft'] || keys['KeyA']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['KeyD']) player.x += player.speed;

            // Tur ve Seviye Kontrolü
            angle += rotationSpeed;
            let diff = angle - lastAngle;
            totalRotation += diff;
            lastAngle = angle;

            currentLaps = Math.floor(totalRotation / (Math.PI * 2));
            document.getElementById("tur").innerText = `TUR: ${currentLaps % 2} / 2`;

            if (currentLaps >= 2) {
                levelUp();
            }

            // Işık Sayısı Ayarı
            let numBeams = 1;
            if (level >= 4) numBeams = 2;
            if (level >= 8) numBeams = 3;

            // Çarpışma Kontrolü
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const pAngle = Math.atan2(player.y - cy, player.x - cx);
            
            let caught = false;
            for(let i=0; i < numBeams; i++) {
                let beamAngle = (angle + (i * Math.PI * 2 / numBeams)) % (Math.PI * 2);
                let normBeam = ((beamAngle + Math.PI) % (Math.PI * 2)) - Math.PI;
                if (Math.abs(pAngle - normBeam) < 0.25) {
                    if (!checkInShadow(player.x, player.y, beamAngle)) {
                        caught = true;
                    }
                }
            }

            if (caught) gameOver();

            score++;
            document.getElementById("score").innerText = "PUAN: " + Math.floor(score/10);
            document.getElementById("lvl").innerText = "SEVİYE: " + level;
        }

        function levelUp() {
            if (level >= 10) return; // Maksimum seviye
            level++;
            totalRotation = 0;
            currentLaps = 0;
            rotationSpeed += 0.01;
            
            const msg = document.getElementById("level-up");
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 1000);
        }

        function gameOver() {
            gameActive = false;
            alert("YAKALANDIN! Skorun: " + Math.floor(score/10) + "\nSeviye: " + level);
            location.reload();
        }

        function draw() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Işıkları Çiz
            let numBeams = 1;
            if (level >= 4) numBeams = 2;
            if (level >= 8) numBeams = 3;

            for(let i=0; i < numBeams; i++) {
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(angle + (i * Math.PI * 2 / numBeams));
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.lineTo(2000, -80);
                ctx.lineTo(2000, 80);
                ctx.fillStyle = "rgba(255, 255, 0, 0.3)";
                ctx.fill();
                ctx.restore();
            }

            // Engelleri Çiz
            obstacles.forEach(drawObstacle);

            // Oyuncuyu Çiz
            ctx.fillStyle = "cyan";
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
            ctx.fill();

            update();
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
