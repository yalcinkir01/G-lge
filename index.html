<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gölge Ustası - Fix</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        canvas { display: block; background: #000; }
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10; }
        .stat { font-size: 18px; margin-bottom: 5px; background: rgba(0,0,0,0.5); padding: 5px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat" id="lvl">SEVİYE: 1</div>
        <div class="stat" id="tur">TUR: 0 / 2</div>
        <div class="stat" id="score">PUAN: 0</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // --- DEĞİŞKENLER ---
        let level = 1;
        let score = 0;
        let angle = 0;
        let rotationSpeed = 0.02;
        let totalRotation = 0;
        let lastAngle = 0;
        let gameActive = true;

        let player = { x: 50, y: 50, radius: 10, speed: 5 };
        let keys = {};

        // Engelleri tanımla (Ekranın merkezine göre ofsetli)
        const obstacles = [
            { x: -150, y: -150, size: 50, type: 'square' },
            { x: 150, y: -100, size: 60, type: 'triangle' },
            { x: 0, y: 180, size: 50, type: 'pentagon' }
        ];

        // --- KONTROLLER ---
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Oyuncuyu başlat
            player.x = 100;
            player.y = 100;
            draw();
        }

        // Bir şeklin köşe noktalarını dünya koordinatlarına çevirir
        function getVertices(obs) {
            const cx = canvas.width / 2 + obs.x;
            const cy = canvas.height / 2 + obs.y;
            let vertices = [];
            let sides = obs.type === 'square' ? 4 : (obs.type === 'triangle' ? 3 : 5);
            
            for (let i = 0; i < sides; i++) {
                let a = (i * 2 * Math.PI / sides) - Math.PI / 2;
                // Kareyi biraz döndürelim ki daha güzel dursun
                if(obs.type === 'square') a += Math.PI / 4; 
                vertices.push({
                    x: cx + obs.size * Math.cos(a),
                    y: cy + obs.size * Math.sin(a)
                });
            }
            return vertices;
        }

        // Gölge Çizimi: Işığın geçmesini engeller
        function drawShadow(vertices, lightAngle) {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            ctx.fillStyle = "black";
            ctx.beginPath();
            
            // Her köşe noktası için ışığın vurduğu yöne doğru bir gölge hacmi oluştur
            for (let i = 0; i < vertices.length; i++) {
                let v1 = vertices[i];
                let v2 = vertices[(i + 1) % vertices.length];

                let a1 = Math.atan2(v1.y - cy, v1.x - cx);
                let a2 = Math.atan2(v2.y - cy, v2.x - cx);

                ctx.moveTo(v1.x, v1.y);
                ctx.lineTo(v1.x + Math.cos(a1) * 2000, v1.y + Math.sin(a1) * 2000);
                ctx.lineTo(v2.x + Math.cos(a2) * 2000, v2.y + Math.sin(a2) * 2000);
                ctx.lineTo(v2.x, v2.y);
            }
            ctx.fill();
        }

        function update() {
            if (!gameActive) return;

            // Hareket
            if (keys['ArrowUp'] || keys['KeyW']) player.y -= player.speed;
            if (keys['ArrowDown'] || keys['KeyS']) player.y += player.speed;
            if (keys['ArrowLeft'] || keys['KeyA']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['KeyD']) player.x += player.speed;

            // Açı ve Tur
            angle += rotationSpeed;
            totalRotation += Math.abs(angle - lastAngle);
            lastAngle = angle;

            let laps = Math.floor(totalRotation / (Math.PI * 2));
            document.getElementById("tur").innerText = `TUR: ${laps % 2} / 2`;

            if (laps > 0 && laps % 2 === 0 && laps / 2 >= level) {
                level++;
                rotationSpeed += 0.005;
                document.getElementById("lvl").innerText = `SEVİYE: ${level}`;
            }

            // Çarpışma Kontrolü (Basit Işık Testi)
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const pAngle = Math.atan2(player.y - cy, player.x - cx);
            
            let numBeams = level >= 8 ? 3 : (level >= 4 ? 2 : 1);
            let hitByLight = false;

            for (let i = 0; i < numBeams; i++) {
                let beamAngle = (angle + (i * Math.PI * 2 / numBeams));
                let normBeam = Math.atan2(Math.sin(beamAngle), Math.cos(beamAngle));
                
                if (Math.abs(pAngle - normBeam) < 0.25) {
                    hitByLight = true;
                }
            }

            // Gölge Kontrolü
            let inShadow = false;
            obstacles.forEach(obs => {
                const ox = cx + obs.x;
                const oy = cy + obs.y;
                const distP = Math.hypot(player.x - cx, player.y - cy);
                const distO = Math.hypot(ox - cx, oy - cy);
                if (distP > distO) {
                    const oAngle = Math.atan2(oy - cy, ox - cx);
                    if (Math.abs(pAngle - oAngle) < 0.3) inShadow = true;
                }
            });

            if (hitByLight && !inShadow) {
                gameActive = false;
                alert("Işığa Yakalandın! Seviye: " + level);
                location.reload();
            }

            score++;
            document.getElementById("score").innerText = "PUAN: " + Math.floor(score/10);
        }

        function draw() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // 1. Arka Plan
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Işıkları Çiz
            let numBeams = level >= 8 ? 3 : (level >= 4 ? 2 : 1);
            for (let i = 0; i < numBeams; i++) {
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(angle + (i * Math.PI * 2 / numBeams));
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(2000, -120);
                ctx.lineTo(2000, 120);
                ctx.fillStyle = "rgba(255, 255, 150, 0.4)";
                ctx.fill();
                ctx.restore();
            }

            // 3. Gölgeler ve Engeller
            obstacles.forEach(obs => {
                const vertices = getVertices(obs);
                
                // Gölgeyi çiz (Işığın üstüne biner)
                drawShadow(vertices, angle);

                // Şekli çiz
                ctx.beginPath();
                ctx.moveTo(vertices[0].x, vertices[0].y);
                vertices.forEach(v => ctx.lineTo(v.x, v.y));
                ctx.closePath();
                ctx.fillStyle = "#444";
                ctx.fill();
                ctx.strokeStyle = "white";
                ctx.stroke();
            });

            // 4. Oyuncu
            ctx.fillStyle = "cyan";
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();

            update();
            requestAnimationFrame(draw);
        }

        window.onload = init;
    </script>
</body>
</html>
